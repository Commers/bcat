#!/usr/bin/env ruby
# Usage: bcat [<file>]...
# Concatenate <file>s, or standard input, to browser.
require 'rack'
require 'bcat/kidgloves'

class PipeResponse
  include Rack::Utils

  def call(env)
    [200, {"Content-Type" => "text/html;charset=utf-8"}, self]
  end

  def each
    yield "\n" * 1000
    yield "<!DOCTYPE html>\n"
    yield "<html><body><pre>"

    begin
      while buf = $stdin.readpartial(4096)
        output = escape_html(buf)
        output = output.gsub(/\n/, "<br>")
        yield "<script>document.write('#{output}');</script>"
      end
    rescue EOFError, Interrupt
    end

    yield "</pre></body></html>"
    exit! 0
  end
end

host = '127.0.0.1'
port = 8091
app =
  Rack::Builder.new do
    use Rack::Chunked
    run PipeResponse.new
  end

Rack::Handler::KidGloves.run app, :Host => host, :Port => port do |sock|
  fork do
    sock.close
    $stdin.close
    $stdout.close
    exec "open http://localhost:#{port}/#{File.basename(Dir.pwd)} >/dev/null"
  end
end
