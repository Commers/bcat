#!/usr/bin/env ruby
# Usage: bcat [<file>]...
# Read standard input, or one or more <file>s, and write to browser.
require 'bcat'

fds =
  ARGV.map do |file|
    if file == '-'
      $stdin
    else
      File.open(file, 'rb')
    end
  end
fds = [$stdin] if fds.empty?

command = ENV['BCAT_COMMAND'] || 'open $BCAT_ARGS "$BCAT_URL"'

pid = nil
begin
  bcat = Bcat.new(fds)
  bcat.serve! do |sock|
    pid =
      fork do
        (fds + [sock, $stdin, $stdout]).uniq.each { |fd| fd.close }
        ENV['BCAT_URL'] = "http://#{bcat[:Host]}:#{bcat[:Port]}/#{File.basename(Dir.pwd)}"
        ENV['BCAT_ARGS'] = "-a '#{ENV['BCAT_APPLICATION']}'" if !ENV['BCAT_APPLICATION'].to_s.empty?
        exec "/bin/sh -c \"#{command}\""
      end
  end
rescue Interrupt
end

Process.wait(pid) if pid
exit $?
